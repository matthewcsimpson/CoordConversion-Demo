<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>title</title>

    <script src="https://unpkg.com/coordconversion@latest/dist/index.global.js"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>CoordConversions Demo</h1>

    <div class="coordinate-container">
        <h3>Enter Coordinates</h3>
        <form id="coordinateForm">
            <label for="latitude">Latitude (decimal degrees):</label>
            <input type="number" id="latitude" step="any" placeholder="37.7749">

            <label for="longitude">Longitude (decimal degrees):</label>
            <input type="number" id="longitude" step="any" placeholder="-122.4194">

            <button type="submit">Go to Location</button>
            <button type="button" id="currentLocationBtn">Use Current Location</button>
        </form>

        <div class="precision-settings">
            <h4>Precision Settings</h4>
            <div class="precision-controls">
                <label>
                    DD Precision:
                    <input type="number" id="ddPrecision" min="1" max="10" value="5"
                        title="Decimal places for DD format">
                </label>
                <label>
                    DM Precision:
                    <input type="number" id="dmPrecision" min="1" max="10" value="2"
                        title="Decimal places for minutes in DM format (minimum 1)">
                </label>
                <label>
                    DMS Precision:
                    <input type="number" id="dmsPrecision" min="1" max="10" value="2"
                        title="Decimal places for seconds in DMS format (minimum 1)">
                </label>
            </div>
        </div>

        <div class="coordinate-displays">
            <div id="ddCoordinates">
                <label>
                    <input type="checkbox" id="ddToggle" checked>
                    <strong>ðŸŸ¢ DD Format:</strong> <span id="ddDisplay">--</span>
                </label>
            </div>

            <div id="dmCoordinates">
                <label>
                    <input type="checkbox" id="dmToggle" checked>
                    <strong>ðŸŸ  DM Format:</strong> <span id="dmDisplay">--</span>
                </label>
            </div>

            <div id="dmsCoordinates">
                <label>
                    <input type="checkbox" id="dmsToggle" checked>
                    <strong>ðŸ”µ DMS Format:</strong> <span id="dmsDisplay">--</span>
                </label>
            </div>

            <div id="inputCoordinates">
                <label>
                    <input type="checkbox" id="inputToggle" checked>
                    <strong>ðŸ”´ Input Format:</strong> <span id="inputDisplay">--</span>
                </label>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let markers = {
            input: null,
            dd: null,
            dm: null,
            dms: null
        };

        // Initialize and add the map
        function initMap() {
            // Default location (San Francisco)
            const defaultLocation = [37.7749, -122.4194]; // Note: Leaflet uses [lat, lng] format

            // Create the map with OpenStreetMap tiles
            map = L.map('map').setView(defaultLocation, 18);

            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Create custom icons for different marker types
            const redIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:red;width:12px;height:12px;border-radius:50%;border:2px solid white;'></div>",
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            const greenIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:green;width:12px;height:12px;border-radius:50%;border:2px solid white;'></div>",
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            const orangeIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:orange;width:12px;height:12px;border-radius:50%;border:2px solid white;'></div>",
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            const blueIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:blue;width:12px;height:12px;border-radius:50%;border:2px solid white;'></div>",
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            // Create initial markers for each format
            markers.input = L.marker(defaultLocation, {
                icon: redIcon,
                title: "Input coordinates"
            }).addTo(map);

            markers.dd = L.marker(defaultLocation, {
                icon: greenIcon,
                title: "DD Format"
            }).addTo(map);

            markers.dm = L.marker(defaultLocation, {
                icon: orangeIcon,
                title: "DM Format"
            }).addTo(map);

            markers.dms = L.marker(defaultLocation, {
                icon: blueIcon,
                title: "DMS Format"
            }).addTo(map);

            // Set up form event listener
            document.getElementById('coordinateForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const lat = parseFloat(document.getElementById('latitude').value);
                const lng = parseFloat(document.getElementById('longitude').value);

                if (isValidCoordinate(lat, lng)) {
                    updateMapLocation(lat, lng, "Custom location");
                } else {
                    alert("Please enter valid coordinates. Latitude must be between -90 and 90, longitude between -180 and 180.");
                }
            });

            // Set up current location button
            document.getElementById('currentLocationBtn').addEventListener('click', function () {
                getCurrentLocation();
            });

            // Set up toggle event listeners
            document.getElementById('inputToggle').addEventListener('change', function () {
                if (this.checked) {
                    markers.input.addTo(map);
                } else {
                    map.removeLayer(markers.input);
                }
            });

            document.getElementById('ddToggle').addEventListener('change', function () {
                if (this.checked) {
                    markers.dd.addTo(map);
                } else {
                    map.removeLayer(markers.dd);
                }
            });

            document.getElementById('dmToggle').addEventListener('change', function () {
                if (this.checked) {
                    markers.dm.addTo(map);
                } else {
                    map.removeLayer(markers.dm);
                }
            });

            document.getElementById('dmsToggle').addEventListener('change', function () {
                if (this.checked) {
                    markers.dms.addTo(map);
                } else {
                    map.removeLayer(markers.dms);
                }
            });

            // Set up precision control event listeners
            document.getElementById('ddPrecision').addEventListener('change', function () {
                // Re-run coordinate conversion when precision changes
                const lat = parseFloat(document.getElementById('latitude').value);
                const lng = parseFloat(document.getElementById('longitude').value);
                if (isValidCoordinate(lat, lng)) {
                    updateMapLocation(lat, lng, "Updated precision");
                }
            });

            document.getElementById('dmPrecision').addEventListener('change', function () {
                const lat = parseFloat(document.getElementById('latitude').value);
                const lng = parseFloat(document.getElementById('longitude').value);
                if (isValidCoordinate(lat, lng)) {
                    updateMapLocation(lat, lng, "Updated precision");
                }
            });

            document.getElementById('dmsPrecision').addEventListener('change', function () {
                const lat = parseFloat(document.getElementById('latitude').value);
                const lng = parseFloat(document.getElementById('longitude').value);
                if (isValidCoordinate(lat, lng)) {
                    updateMapLocation(lat, lng, "Updated precision");
                }
            });

            // Try to get current location on page load
            getCurrentLocation();
        }

        function isValidCoordinate(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) &&
                lat >= -90 && lat <= 90 &&
                lng >= -180 && lng <= 180;
        }

        function updateMapLocation(lat, lng, title) {
            const inputLocation = [lat, lng]; // Leaflet uses [lat, lng] format

            // Update map center to input coordinates
            map.setView(inputLocation, 18);

            // Update form fields
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);

            // Display input coordinates
            document.getElementById('inputDisplay').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            // Update input marker (red)
            markers.input.setLatLng(inputLocation);
            markers.input.bindTooltip(`Input: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            if (document.getElementById('inputToggle').checked) {
                markers.input.addTo(map);
            }

            // Convert to DD format using coordconversion library
            try {
                // Parse the numeric input to DD objects, then format for display
                const [latDD, lonDD] = CoordConversion.parsePairToDD(lat, lng);
                const ddPrecision = parseInt(document.getElementById('ddPrecision').value) || 5;
                const [latStrDD, lonStrDD] = CoordConversion.formatDDPair(latDD, lonDD, ddPrecision);
                document.getElementById('ddDisplay').textContent = `${latStrDD}, ${lonStrDD}`;

                // Convert the FORMATTED strings back to DD objects to apply precision loss
                const [latDDPrecise, lonDDPrecise] = CoordConversion.parsePairToDD(latStrDD, lonStrDD);
                const ddLocation = [latDDPrecise.degrees, lonDDPrecise.degrees];
                markers.dd.setLatLng(ddLocation);
                markers.dd.bindTooltip(`DD: ${latStrDD}, ${lonStrDD} (Converted back: ${latDDPrecise.degrees.toFixed(8)}, ${lonDDPrecise.degrees.toFixed(8)})`);
                if (document.getElementById('ddToggle').checked) {
                    markers.dd.addTo(map);
                }
            } catch (error) {
                console.error("Error converting coordinates to DD format:", error);
                document.getElementById('ddDisplay').textContent = "Conversion error";
            }

            // Convert to DM format using coordconversion library
            try {
                // Use the streamlined workflow with precision options
                const [latDD, lonDD] = CoordConversion.parsePairToDD(lat, lng);
                const dmPrecision = Math.max(1, parseInt(document.getElementById('dmPrecision').value) || 2);

                // Apply precision during conversion using function options
                const [latDM, lonDM] = CoordConversion.ddPairToDM(latDD, lonDD, { decimals: dmPrecision });
                const [latStrDM, lonStrDM] = CoordConversion.formatDMPair(latDM, lonDM);

                document.getElementById('dmDisplay').textContent = `${latStrDM}, ${lonStrDM}`;

                // Convert DM back to DD for mapping to SHOW THE DRIFT from precision loss
                const [dmLatObj, dmLngObj] = CoordConversion.dmPairToDD(latDM, lonDM);
                const dmLocation = [dmLatObj.degrees, dmLngObj.degrees];

                // Debug: Log the DM objects to see the actual precision applied
                console.log(`DM Precision ${dmPrecision}:`, {
                    original: { lat: lat, lng: lng },
                    dm: {
                        lat: { degrees: latDM.degrees, minutes: latDM.minutes, hemi: latDM.hemi },
                        lng: { degrees: lonDM.degrees, minutes: lonDM.minutes, hemi: lonDM.hemi }
                    },
                    formatted: { lat: latStrDM, lng: lonStrDM },
                    convertedBack: { lat: dmLatObj.degrees, lng: dmLngObj.degrees }
                });

                markers.dm.setLatLng(dmLocation);
                markers.dm.bindTooltip(`DM: ${latStrDM}, ${lonStrDM} (Converted back: ${dmLatObj.degrees.toFixed(8)}, ${dmLngObj.degrees.toFixed(8)})`);
                if (document.getElementById('dmToggle').checked) {
                    markers.dm.addTo(map);
                }
            } catch (error) {
                console.error("Error converting coordinates to DM format:", error);
                document.getElementById('dmDisplay').textContent = "Conversion error";
            }            // Convert to DMS format using coordconversion library
            try {
                // Use the streamlined workflow with precision options
                const [latDD, lonDD] = CoordConversion.parsePairToDD(lat, lng);
                const dmsPrecision = Math.max(1, parseInt(document.getElementById('dmsPrecision').value) || 2);

                // Apply precision during conversion using function options
                const [latDMS, lonDMS] = CoordConversion.ddPairToDMS(latDD, lonDD, { decimals: dmsPrecision });
                const [latStrDMS, lonStrDMS] = CoordConversion.formatDMSPair(latDMS, lonDMS);

                document.getElementById('dmsDisplay').textContent = `${latStrDMS}, ${lonStrDMS}`;

                // Convert DMS back to DD for mapping to SHOW THE DRIFT from precision loss
                const [dmsLatObj, dmsLngObj] = CoordConversion.dmsPairToDD(latDMS, lonDMS);
                const dmsLocation = [dmsLatObj.degrees, dmsLngObj.degrees];
                markers.dms.setLatLng(dmsLocation);
                markers.dms.bindTooltip(`DMS: ${latStrDMS}, ${lonStrDMS} (Converted back: ${dmsLatObj.degrees.toFixed(8)}, ${dmsLngObj.degrees.toFixed(8)})`);
                if (document.getElementById('dmsToggle').checked) {
                    markers.dms.addTo(map);
                }
            } catch (error) {
                console.error("Error converting coordinates to DMS format:", error);
                document.getElementById('dmsDisplay').textContent = "Conversion error";
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateMapLocation(lat, lng, "Your current location");
                    },
                    function (error) {
                        console.error("Error getting location:", error);
                        alert("Could not get your current location. Error: " + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Initialize the map when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
        });
    </script>
</body>

</html>